<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-17547010-1']);
    _gaq.push(['_trackPageview']);
    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Novel Coronavirus (COVID-19)</title>
  <link rel="stylesheet" type="text/css" href="css/normalize.css" />
  <link rel="stylesheet" type="text/css" href="css/reboot.css" />
  <link rel="stylesheet" type="text/css" href="css/fonts.css" />
  <link href='js/mapbox-gl.css' rel='stylesheet' />
  <link rel="stylesheet" type="text/css" href="css/styles.css?b" />
</head>
<body>
	    <!-- modal structure -->
  <div class="modal-wrapper" id="modal">
    <div class="modal-backdrop"></div>
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Contributors</div>
        <div class="modal-cancel"><img src="img/close-icon.svg" width="20" height="20" alt="Close" /></div>
      </div>
      <div class="modal-body">
        <ul>
      		<li>Isha Berry, <a href="mailto:isha.berry@mail.utoronto.ca">isha.berry@mail.utoronto.ca</a></li>
          <li>John Brownstein, <a href="mailto:John.Brownstein@childrens.harvard.edu">John.Brownstein@childrens.harvard.edu</a></li>
          <li>Emily Cohn, <a href="mailto:Emily.Cohn@childrens.harvard.edu">Emily.Cohn@childrens.harvard.edu</a></li>
          <li>Lauren Goodwin, <a href="mailto:Lauren.Goodwin@childrens.harvard.edu">Lauren.Goodwin@childrens.harvard.edu</a></li>
          <li>Bernardo Gutierrez, <a href="mailto:bernardo.gutierrez@zoo.ox.ac.uk">bernardo.gutierrez@zoo.ox.ac.uk</a></li>
          <li>Sarah Hill, <a href="mailto:sarah.hill@zoo.ox.ac.uk">sarah.hill@zoo.ox.ac.uk</a></li>
          <li>Erin Hulland, <a href="mailto:ehulland@uw.edu">ehulland@uw.edu</a></li>
          <li>Moritz Kraemer, <a href="mailto:moritz.kraemer@zoo.ox.ac.uk">moritz.kraemer@zoo.ox.ac.uk</a></li>
      		<li>Anastasia Lambrou, <a href="mailto:anastasia.lambrou@jhu.edu">anastasia.lambrou@jhu.edu</a></li>
          <li>Sabrina Li, <a href="mailto:sabrina.li@ouce.ox.ac.uk">sabrina.li@ouce.ox.ac.uk</a></li>
          <li>Alyssa Loskill, <a href="mailto:aloskill@bu.edu">aloskill@bu.edu</a></li>
          <li>Sumiko Mekaru, <a href="mailto:srmekaru@gmail.com">srmekaru@gmail.com</a></li>
          <li>Julia Morgan, <a href="mailto:morgaj5@uw.edu">morgaj5@uw.edu</a></li>
          <li>Katelynn O'Brien, <a href="mailto:katelynn.obrien@childrens.harvard.edu">katelynn.obrien@childrens.harvard.edu</a></li>
          <li>David Pigott, <a href="mailto:pigottdm@uw.edu">pigottdm@uw.edu</a></li>
      		<li>Oliver Pybus, <a href="mailto:oliver.pybus@zoo.ox.ac.uk">oliver.pybus@zoo.ox.ac.uk</a></li>
          <li>Sam Scarpino, <a href="mailto:s.scarpino@northeastern.edu">s.scarpino@northeastern.edu</a></li>
          <li>Kara Sewalk, <a href="mailto:Kara.Sewalk@childrens.harvard.edu">Kara.Sewalk@childrens.harvard.edu</a></li>
      		<li>Lin Wang, <a href="mailto:lin.wang@pasteur.fr">lin.wang@pasteur.fr</a></li>
          <li>Jessie Wu, <a href="mailto:chiehhsi.wu@gmail.com">chiehhsi.wu@gmail.com</a></li>
          <li>Bo Xu, <a href="mailto:xu-b15@mails.tsinghua.edu.cn">xu-b15@mails.tsinghua.edu.cn</a></li>
          <li>Alex Zarebski, <a href="mailto:aezarebski@gmail.com">aezarebski@gmail.com</a></li>
        </ul>
        <div class="mobile-logos">
          <img src="img/oxford-blue.svg" class="oxford-logo" alt="University of Oxford" />
          <img src="img/hm-logo-color.svg" class="hm-logo" alt="HealthMap" />
          <img src="img/harvard-logo-color.svg" class="hms-logo" alt="Harvard Medical School" />
          <img src="img/BCH_Primary_Logo.svg" class="bch-logo" alt="Boston Children's Hospital" />
          <img src="img/netsi.png" class="netsi-logo" alt="Network Science Institute at Northeastern University" />
          <img src="img/Oxford_Martin_School_Logo_color.png" class="oxford-martin-logo" alt="Oxford Martin School" />
          <img src="img/Tsinghua_University.png" class="tsinghua-logo" alt="Tsinghua University" />
          <img src="img/IHME_logo_acr_color_large.png" class="ihme-logo" alt="Institute for Health Metrics and Evaluation" />
        </div>
    	  <p class="mobile-disclaimer">All data used to produce this map are exclusively collected from publicly available sources including government reports and news media</p>
      </div>
    </div>
  </div>
  <div class="header">
    <h1>Novel Coronavirus (COVID-19)</h1>
    <ul class="list-unstyled legend-header">
      <li><strong>Number of cases:</strong></li>
      <li><img src="img/pin1.svg" width="25px" height="25px" alt="1" />50+</li>
      <li><img src="img/pin2.svg" width="20px" height="20px" alt="2" />25-49</li>
      <li><img src="img/pin3.svg" width="15px" height="15px" alt="3" />10-24</li>
      <li><img src="img/pin4.svg" width="10px" height="10px" alt="4" />< 10</li>
    </ul>
    <div class="reported-cases">
      <div class="reported-cases-num" id="total-cases"></div>
      <div class="reported-cases-label">Confirmed Cases<br /><span class="last-updated">Last updated: <span class="last-updated-date" id="last-updated-date"></span></span></div>
    </div>
  </div>
  <div class="map-container">
	  <div id="spread"><img src="img/play.svg" width="25" height="25" alt="Play" />Animate Spread</div>
	  <div id="spread-date"></div>
    <div class="footer-wrapper">
	    <div class="footer">
  	    <img src="img/oxford-white.svg" class="oxford-logo" alt="University of Oxford" />
  	    <img src="img/hm-logo.svg" class="hm-logo" alt="HealthMap" />
  	    <img src="img/harvard-logo.svg" class="hms-logo" alt="Harvard Medical School" />
  	    <img src="img/BCHlogomotto_inline_white.svg" class="bch-logo" alt="Boston Children's Hospital" />
  	    <img src="img/netsi-white.png" class="netsi-logo" alt="Network Science Institute at Northeastern University" />
  	    <img src="img/Oxford_Martin_School_Logo.png" class="oxford-martin-logo" alt="Oxford Martin School" />
  	    <img src="img/Tsinghua_University.png" class="tsinghua-logo" alt="Tsinghua University" />
  	    <img src="img/IHME_logo_acr_WHITE_large.png" class="ihme-logo" alt="Institute for Health Metrics and Evaluation" />
  	    <div id="credits">
  	      <div id="contributors">Full list of contributors</div>
  	      <div id="source"><a href="https://github.com/beoutbreakprepared/nCoV2019" target="_new">nCoV2019 Dataset</a></div>
  	    </div>
  	  </div>
  	  <p class="disclaimer">All data used to produce this map are exclusively collected from publicly available sources including government reports and news media</p>
    </div>
    <div id="map"></div>
  </div>

  <script type="text/javascript" src="js/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src='./js/mapbox-gl.js'></script>

  <script type="text/javascript">

    $(document).ready(function() {
      // json files - append date/time string to prevent caching
      var staticCasesJson = './ncov2019.unique-locations.json?nocache=' + (new Date()).getTime();
      var animatedCasesJson = './ncov2019.animation-data.json?nocache=' + (new Date()).getTime();
      var latestCountsJson = './latestCounts.json?nocache=' + (new Date()).getTime();

      var transitionEnd = 'webkitTransitionEnd otransitionend oTransitionEnd msTransitionEnd transitionend';
      var showModal = function() {
        // switch elements to have 'display' value (block, flex) but keep hidden via opacity
        $('.modal-wrapper').addClass('is-block').outerWidth();
        $('.modal').addClass('is-flex').outerWidth();
        // add css class for transitioning via opacity
        $('.modal-wrapper').addClass('is-visible');
        $('.modal').addClass('is-visible');
      }
      var closeModal = function() {
        $('.modal-wrapper, .modal')
          .removeClass('is-visible')
          .one(transitionEnd, function() {
            $('.modal-wrapper').removeClass('is-block');
            $('.modal').removeClass('is-flex');
          });
      }

      $('#contributors').click(function() {
        showModal();
      })
      $('.modal-backdrop, .modal-cancel').click(function() {
        closeModal();
      })

      // begin animation of markers
      $('#spread').click(function() {
        clearMarkers(markers);
        clearMarkers(animatedMarkers);
        startAnimation();
      })

      // clear markers from map
      function clearMarkers(markersArray) {
        for (var i = 0; i < markersArray.length; i++) {
          markersArray[i].remove();
        }
        markersArray = []
      }

      // set marker styles
      function setMarkerStyle(caseCount) {
        if (caseCount < 10) {
          pinClass = 'pin4';
        } else if (caseCount>= 10 && caseCount <= 24) {
          pinClass = 'pin3';
        } else if (caseCount >= 25 && caseCount <= 49) {
          pinClass = 'pin2';
        } else if (caseCount >= 50) {
          pinClass = 'pin1';
        }
        return pinClass
      }

      // format date as yyyy-mm-dd
      function parseDate(str) {
        var mdy = str.split('.');
        var formattedDate = new Date(mdy[2], mdy[1], mdy[0]);
        return formattedDate.getFullYear() + '-' + ('0' + formattedDate.getMonth()).slice(-2) + '-' + ('0' + formattedDate.getDate()).slice(-2);
      }

      // pase date for comparison
      function parseDateForCompare(str) {
        var mdy = str.split('-');
        return new Date(mdy[0], mdy[1]-1, mdy[2]);
      }

      var today = new Date();
      var formattedToday =  today.getFullYear() + '-' + ('0' + (today.getMonth() + 1)).slice(-2) + '-' + ('0' + today.getDate()).slice(-2);

      // get latest case counts from scraped data
      $.getJSON(latestCountsJson, function(json) {
        var counts = json[0].caseCount;
        var formattedDate = json[0].date;
        $('#total-cases').html(counts);
        $('#last-updated-date').html(formattedDate);
      });

      // establish map
      mapboxgl.accessToken = 'pk.eyJ1Ijoia2F0ZWx5bm5vYnJpZW4iLCJhIjoiY2sxa3ZjbTR4MDA2bTNjcGR4cXIwZnJidSJ9.wrkfV082TaX5P65i2L8upg';
      var map = new mapboxgl.Map({
        container: 'map', // HTML container id
        style: 'mapbox://styles/katelynnobrien/ck5y23wmc0aso1iqtbww5nzrr',
        center: [10, 0], // starting position as [lng, lat]
        zoom: 1
      });
      // Add zoom and rotation controls to the map.
      map.addControl(new mapboxgl.NavigationControl());

      // Set arrays to store markers
      var markers = [];
      var animatedMarkers = [];

      // create marker and put on map
      function createMarker(cssClass, lon, lat, markerArray, popup) {
        var customMarker = document.createElement('div');
        customMarker.className = cssClass
        var marker = new mapboxgl.Marker(customMarker)
        if (popup) {
          marker.setPopup(popup)
        }
        marker
        .setLngLat([lon, lat])
        .addTo(map)
        markerArray.push(marker);
      }

      // animate spread of disease
      function startAnimation() {
        $.getJSON(animatedCasesJson, function(json) {
          var numDates = json.length
          var count = 0;
          map.flyTo({ zoom: 3, center: [102,24] });
          function animateMarkers() {
            var dateDetails = json[count]
            var date = Object.keys(dateDetails);
            var compareDate = parseDateForCompare(date[0]);
            if ((today.getTime() - compareDate.getTime()) < 0) {
                setTimeout(function() {
                  staticMarkers(); // finish animation on static pins with popups
                }, 600);
            } else {
              var locations = dateDetails[date]
              if (date[0] === '2020-01-20') {
                map.flyTo({ zoom: 1, center: [10,0] });
              }
              setTimeout(function() {
                $('#spread-date').show().html(date[0]);
                if (count === 0) {
                  createMarker('pin1', 114.2797, 30.596415, animatedMarkers);
                }
                locations.map(function(location, i) {
                  var caseCount = location.caseCount
                  var pinClass = location.pin.split('.');
                  if (location.longitude !== '' && location.latitude !== '') {
                    createMarker(pinClass[0],location.longitude, location.latitude, animatedMarkers);
                  }
                })
                count++;
                animateMarkers();
              }, 600);
            }
          }
          // add initial marker to Wuhan to fix discrepencies with missing date_confirmation
          createMarker('pin2', 114.2797, 30.596415, animatedMarkers);
          animateMarkers()
        })

      }

      function staticMarkers() {
        $('#spread-date').hide().html();

        $.getJSON(staticCasesJson, function(json) {

          // the 2 datasets that drive the rest
          var outsideHubeiCases = json.outside_Hubei
          var hubeiCases = json.Hubei
          var totalCases = json.totalCases

          placeMarkers(outsideHubeiCases)
          placeMarkers(hubeiCases)


          function placeMarkers(locationsData) {
            $.each(locationsData, function(k, v) {
            	var uniqueLat = !Number.isNaN(v.latitude) ? v.latitude : ''
              var uniqueLon = !Number.isNaN(v.longitude) ? v.longitude : ''
            	var caseCount = v.cases
            	var uniqueCity = v.city
            	var uniqueProvince = v.province
            	var uniqueCountry = v.country
            	var pinClass = ''

              if ((uniqueLat !== '' && uniqueLat !== '#REF!') && (uniqueLon !== '' && uniqueLon !== '#REF!')) {

            	  pinClass = setMarkerStyle(caseCount);

            	  var city = v.city ? v.city+', ' : '';
                var province = v.province ? v.province+', ' : '';
                var country = v.country ? v.country : '';
            	  var age = v.age ? v.age : '';
            	  var sex = v.sex ? v.sex : '';
            	  var symptoms = v.symptoms ? v.symptoms : '';
            	  var dateConfirmation = v.date_confirmation ? v.date_confirmation : '';
            	  var printDate = '';
            	  var source = v.source ? v.source : '';

            	  if (caseCount === 1) {
                  var age = (age !== undefined && age !== '') ? '<div><strong>Age:</strong> '+age+'</div>' : '';
                  var sex = (sex !== undefined && sex !== '') ? '<div><strong>Sex:</strong> '+sex+'</div>' : '';
                  var symptoms = (symptoms !== undefined && symptoms !== '') ? '<div><strong>Reported Symptoms: </strong>'+ symptoms+'</div>' : '';
                  if (dateConfirmation) {
                    var formattedDate = parseDate(dateConfirmation)
                    var printDate = '<div><strong>Date Confirmed: </strong>' + formattedDate + '</div>';
                  }
                  var source = source ? '<div><a href='+source+' target="_new">Source</a></div>' : '';
                } else {
                  sex = '';
                  age = '';
                  symptoms = '';
                  source = '';
                }

            	  popupContent =
                  '<h1 class="popup-header">' + city + province + country + '</h1>' +
                  '<div>' + '<strong>Number of Cases: </strong>' + caseCount + '</div>' +
                  sex +
                  age +
                  symptoms +
            	    printDate +
                  source ;

            	  var popup = new mapboxgl.Popup().setHTML(popupContent)
                createMarker(pinClass, uniqueLon, uniqueLat, markers, popup);
              }

            })
      	    clearMarkers(animatedMarkers);
      	    animatedMarkers = [];
          }
        });
      }

      // load initial markers
      staticMarkers();

    })

  </script>
</body>
</html>
